name: Build Offline Packages for RHEL 9.6 ARM64

on:
  workflow_dispatch:
    inputs:
      packages:
        description: "è¦ä¸‹è½½çš„è½¯ä»¶åŒ… (ç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚: stress,stress-ng,screen)"
        required: true
        default: "stress,stress-ng,screen"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Prepare workspace
      run: |
        mkdir -p output/rpms
        mkdir -p output/docs

    - name: Download RPMs (RHEL 9.6 ARM64 compatible)
      run: |
        # ä»¥é€—å·åˆ†éš”è¾“å…¥çš„è½¯ä»¶åŒ…åˆ—è¡¨
        PKGS="${{ github.event.inputs.packages }}"

        echo "Downloading packages: $PKGS"

        docker run --rm -v $PWD/output:/out almalinux:9 bash -c "
          dnf install -y epel-release dnf-plugins-core
          cd /out/rpms

          # å¾ªçŽ¯ä¸‹è½½æ¯ä¸€ä¸ª package
          for p in ${PKGS//,/ }; do
            echo 'Downloading:' \$p
            mkdir -p /out/rpms/\$p
            cd /out/rpms/\$p
            dnf download --resolve --arch=aarch64 \$p || echo 'Package '\$p' not found'
            ls -lah
            cd /out/rpms
          done
        "

    - name: Generate offline install guide
      run: |
        cat > output/docs/INSTALL_GUIDE.md << 'EOF'
          # Offline Installation Guide for RHEL 9.6 ARM64
          æœ¬åŽ‹ç¼©åŒ…åŒ…å«å¤šä¸ªé€‚ç”¨äºŽ **RHEL 9.6 ARM64 (aarch64)** çš„ç¦»çº¿å®‰è£… RPM åŒ…ã€‚
          è¿™äº› RPM å·²è‡ªåŠ¨è§£æžä¾èµ–ï¼Œå¯åœ¨æ— ç½‘ç»œçŽ¯å¢ƒç›´æŽ¥å®‰è£…ã€‚
          ---
          ## ðŸ“¦ 1. è§£åŽ‹åŽ‹ç¼©åŒ…
          ```bash
          unzip offline-packages.zip
          cd offline-packages
          sudo dnf install -y --nogpgcheck ./*.rpm
          stress-ng --cpu 4 --timeout 10
          stress --cpu 2
          screen --version
        EOF

    - name: Create ZIP package
      run: |
        cd output
        zip -r stress-offline.zip rpms docs

    - name: Upload as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: stress-offline
        path: output/stress-offline.zip
        retention-days: 3
